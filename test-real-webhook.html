<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Webhook R√©el</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .btn { background: #4f46e5; color: white; border: none; padding: 15px 30px; border-radius: 6px; cursor: pointer; margin: 10px; }
        .logs { background: #1f2937; color: #f3f4f6; padding: 15px; border-radius: 6px; font-family: monospace; max-height: 500px; overflow-y: auto; white-space: pre-wrap; }
        .status { padding: 15px; border-radius: 6px; margin: 15px 0; font-weight: bold; }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .warning { background: #fef3c7; color: #92400e; }
        .info { background: #dbeafe; color: #1e40af; }
        .section { background: #f8fafc; padding: 20px; border-radius: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>üß™ Test Webhook R√©el</h1>
    
    <div class="warning">
        <strong>‚ö†Ô∏è Probl√®me actuel:</strong> Les messages WhatsApp r√©els ne sont pas re√ßus.<br>
        <strong>Cause probable:</strong> Webhook non configur√© dans Green API.<br>
        <strong>Solution:</strong> Configurez le webhook et testez ici.
    </div>
    
    <div class="section">
        <h3>üì° Test Direct du Webhook</h3>
        <button class="btn" onclick="testWebhookDirect()">üß™ Test Webhook Direct</button>
        <button class="btn" onclick="testMultipleMessages()">üì± Test Messages Multiples</button>
        <button class="btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        <button class="btn" onclick="startMonitoring()">üîÑ Monitoring Temps R√©el</button>
    </div>
    
    <div class="section">
        <h3>üåê Configuration Green API</h3>
        <p><strong>URL Webhook √† configurer:</strong></p>
        <div class="info">
            https://neda-unspilled-rebbeca.ngrok-free.dev/api/ecom/agent/webhook
        </div>
        <p><strong>√âtapes:</strong></p>
        <ol>
            <li>Allez sur <a href="https://console.green-api.com" target="_blank">Green API Console</a></li>
            <li>Instance: <strong>7103497791</strong></li>
            <li>Section "Webhooks"</li>
            <li>URL: <code>https://neda-unspilled-rebbeca.ngrok-free.dev/api/ecom/agent/webhook</code></li>
            <li>Cochez: ‚úÖ <strong>incomingMessageReceived</strong></li>
            <li>Cliquez "Save"</li>
        </ol>
    </div>
    
    <div id="status"></div>
    
    <h3>üìã Logs en Temps R√©el</h3>
    <div class="logs" id="logs">En attente de tests...</div>
    
    <script>
        let monitoringInterval = null;
        
        function updateStatus(message, type) {
            document.getElementById('status').innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function addLog(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.textContent += `[${timestamp}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logs').textContent = 'Logs effac√©s, en attente...\n';
        }
        
        async function testWebhookDirect() {
            addLog('üöÄ Test webhook direct...');
            
            const testData = {
                typeWebhook: 'incomingMessageReceived',
                payload: {
                    idMessage: 'REAL_' + Date.now(),
                    senderData: {
                        chatId: '237676778377@c.us',
                        sender: '237676778377',
                        senderName: 'Client Test'
                    },
                    textMessage: 'Bonjour, je veux commander une montre',
                    fromMe: false,
                    typeMessage: 'textMessage'
                }
            };
            
            addLog('üì§ Envoi webhook: ' + JSON.stringify(testData, null, 2));
            
            try {
                const response = await fetch('/api/ecom/agent/webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                addLog('üì• R√©ponse: ' + JSON.stringify(result, null, 2));
                
                if (result.success || result.processed) {
                    updateStatus('‚úÖ Test webhook r√©ussi ! Le serveur fonctionne.', 'success');
                    addLog('‚úÖ Le serveur traite bien les messages');
                } else {
                    updateStatus('‚ùå Test webhook √©chou√©: ' + (result.error || 'Erreur inconnue'), 'error');
                    addLog('‚ùå Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                updateStatus('‚ùå Erreur r√©seau: ' + error.message, 'error');
                addLog('‚ùå Erreur r√©seau: ' + error.message);
            }
        }
        
        async function testMultipleMessages() {
            addLog('üöÄ Test messages multiples...');
            
            const messages = [
                'Bonjour',
                'Combien √ßa co√ªte ?',
                'Je veux commander',
                'C\'est quand la livraison ?',
                'Merci'
            ];
            
            for (let i = 0; i < messages.length; i++) {
                const testData = {
                    typeWebhook: 'incomingMessageReceived',
                    payload: {
                        idMessage: 'MULTI_' + Date.now() + '_' + i,
                        senderData: {
                            chatId: '237676778377@c.us',
                            sender: '237676778377',
                            senderName: 'Client Test'
                        },
                        textMessage: messages[i],
                        fromMe: false,
                        typeMessage: 'textMessage'
                    }
                };
                
                addLog(`üì§ Message ${i+1}: ${messages[i]}`);
                
                try {
                    const response = await fetch('/api/ecom/agent/webhook', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testData)
                    });
                    
                    const result = await response.json();
                    addLog(`üì• R√©ponse ${i+1}: ${result.success ? '‚úÖ Succ√®s' : '‚ùå √âchec'}`);
                    
                    // Attendre 2 secondes entre messages
                    if (i < messages.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                } catch (error) {
                    addLog(`‚ùå Erreur message ${i+1}: ${error.message}`);
                }
            }
            
            addLog('‚úÖ Test messages multiples termin√©');
        }
        
        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                addLog('‚èπÔ∏è Monitoring arr√™t√©');
                return;
            }
            
            addLog('üîÑ D√©marrage monitoring temps r√©el...');
            monitoringInterval = setInterval(() => {
                addLog('‚è≥ En attente de messages WhatsApp r√©els...');
                addLog('üí° Envoyez un message au +237698459328');
                addLog('üîç Le webhook devrait appara√Ætre ici si configur√©');
            }, 5000);
        }
        
        // Auto-test au chargement
        window.addEventListener('load', () => {
            setTimeout(testWebhookDirect, 1000);
        });
    </script>
</body>
</html>
